# Proyecto de Automatizaci√≥n de API con Karate DSL

Este proyecto automatiza pruebas de servicios REST utilizando [Karate DSL](https://github.com/karatelabs/karate), empleando Java, JUnit5 y Maven.

---

## üîß Requisitos

- **Java 17 o superior** (Karate no es compatible con Java 24 actualmente --> https://adoptium.net/en-GB/temurin/releases/?version=17&os=any&arch=any)
- **Apache Maven 3.8+** (https://maven.apache.org/download.cgi)
- **Node.js** *(opcional, si usas JS en hooks o scripts complementarios)*
- **Visual Studio Code** (recomendado) con extensiones para Java
- **Karate 1.1.0** Recomendado por dependencias del proyecto
- **karate-junit5** Recomendado por dependencias del proyecto
- **Crear variables de sitema** de entorno %JAVA_HOME%\bin, %MAVEN_HOME%\bin, TNS_ADMIN(con la ubicacion del tsnames)
- **Agregar rutas de instlacion en path de sistema**
- **Agregar extension XML / karate (opcional ideal para la versi√≥n pagada)**
- **Agregar variable de entorno con key para encryptar y decencryptar "ENV_SECRET_KEY"**
- **Considerar subir tsnames.ora como archivo "Pipelines > Library > Secure Files" y otorgar permisos**

# Comprobar instalaciones
```
- java: "java --version"
- maven: "mvn -v"
```
---

## üìÅ Estructura del Proyecto
```
üìÅ api-testing/
‚îú‚îÄ‚îÄ .github/                         # Workflows de CI/CD
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ karate-tests.yml
‚îÇ       ‚îî‚îÄ‚îÄ templates/
‚îÇ           ‚îú‚îÄ‚îÄ karate-tests_docker.yml
‚îÇ           ‚îî‚îÄ‚îÄ karate-tests_sh.yml

‚îú‚îÄ‚îÄ .vscode/                         # Configuraciones de VSCode
‚îÇ   ‚îú‚îÄ‚îÄ karate.code-snippets
‚îÇ   ‚îî‚îÄ‚îÄ settings.json

‚îú‚îÄ‚îÄ scripts/                         # Scripts para generaci√≥n y ejecuci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ generate-karate-schema.js
‚îÇ   ‚îú‚îÄ‚îÄ generate-schema.sh / .bat
‚îÇ   ‚îú‚îÄ‚îÄ input/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ input-response.json      # Ejemplo: response copiado desde Postman
‚îÇ   ‚îî‚îÄ‚îÄ out-put/
‚îÇ       ‚îî‚îÄ‚îÄ schema.json              # Schema generado autom√°ticamente

‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ java/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test/                    # Clases Runner de Karate
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RunAllTests.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RunContentApi.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RunDbTests.java
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RunTemplateApi.java
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ KarateErrorUtils.java
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ OracleDbUtils.java
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ SqlServerUtils.java

‚îÇ   ‚îú‚îÄ‚îÄ resources/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ files/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ DOCUMENTO DE PRUEBA CONTENT.pdf

‚îÇ   ‚îî‚îÄ‚îÄ test/                        # Estructura principal de tests
‚îÇ       ‚îú‚îÄ‚îÄ common/                 # Utilidades JS compartidas
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ utils.js
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ validators.js

‚îÇ       ‚îú‚îÄ‚îÄ content-manager-api/   # Casos de prueba de API Content Manager
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ document/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ post/
‚îÇ       ‚îÇ           ‚îú‚îÄ‚îÄ auth/
‚îÇ       ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ authorization-header.txt
‚îÇ       ‚îÇ           ‚îú‚îÄ‚îÄ data/
‚îÇ       ‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ dynamic-data.js
‚îÇ       ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ payload/
‚îÇ       ‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ carga-basica.json
‚îÇ       ‚îÇ           ‚îú‚îÄ‚îÄ features/
‚îÇ       ‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ load-new-document.feature
‚îÇ       ‚îÇ           ‚îî‚îÄ‚îÄ schemas/
‚îÇ       ‚îÇ               ‚îú‚îÄ‚îÄ not-file-in-directory-response.json
‚îÇ       ‚îÇ               ‚îî‚îÄ‚îÄ success-response.json

‚îÇ       ‚îî‚îÄ‚îÄ template-api/          # APIs adicionales de ejemplo
‚îÇ           ‚îú‚îÄ‚îÄ database/features/
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ test-db.feature
‚îÇ           ‚îú‚îÄ‚îÄ login/post/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ data/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dynamic-data.js
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ features/
‚îÇ           ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ login.feature
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ schemas/
‚îÇ           ‚îÇ       ‚îú‚îÄ‚îÄ login-error.json
‚îÇ           ‚îÇ       ‚îú‚îÄ‚îÄ login-successful.json
‚îÇ           ‚îÇ       ‚îî‚îÄ‚îÄ login-unauthorized.json
‚îÇ           ‚îî‚îÄ‚îÄ user/post/
‚îÇ               ‚îú‚îÄ‚îÄ data/
‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ dynamic-data.js
‚îÇ               ‚îú‚îÄ‚îÄ features/
‚îÇ               ‚îÇ   ‚îî‚îÄ‚îÄ create-user.feature
‚îÇ               ‚îî‚îÄ‚îÄ schemas/
‚îÇ                   ‚îî‚îÄ‚îÄ create-user-success.json

‚îú‚îÄ‚îÄ target/                         # Directorio de salida (ignorado por git)
‚îÇ   ‚îî‚îÄ‚îÄ karate-reports/             # Reportes HTML de ejecuci√≥n

‚îú‚îÄ‚îÄ env.devel.json                  # Variables de entorno por ambiente
‚îú‚îÄ‚îÄ env.qa.json
‚îú‚îÄ‚îÄ env.pre-prod.json
‚îú‚îÄ‚îÄ karate-config.js               # Config global de Karate
‚îú‚îÄ‚îÄ logback-test.xml               # Configuraci√≥n de logs
‚îú‚îÄ‚îÄ pom.xml                        # Dependencias Maven
‚îú‚îÄ‚îÄ README.md                      # Documentaci√≥n del proyecto
‚îî‚îÄ‚îÄ .gitignore


```

---
# üîê Gesti√≥n segura de archivos de entorno en ApiTesting

Este proyecto utiliza archivos `.json` con credenciales y configuraciones sensibles como:

- `env.qa.json`
- `env.devel.json`
- `env.pre-prod.json`

Para proteger esta informaci√≥n sensible y cumplir con buenas pr√°cticas de seguridad y normativas de protecci√≥n de datos, **estos archivos se encriptan** antes de subirse al repositorio.

# üîê M√©todo de encriptaci√≥n utilizado
En tu proyecto estamos utilizando el siguiente esquema:

AES-256-CBC
AES: Advanced Encryption Standard.

256: Tama√±o de clave de 256 bits (clave fuerte).

CBC: Cipher Block Chaining ‚Äî un modo que encadena bloques y usa un IV (vector de inicializaci√≥n) aleatorio para cada cifrado.

¬øC√≥mo se aplica?
La clave (ENV_SECRET_KEY) se convierte en una clave binaria de 256 bits con SHA-256.

Se genera un IV aleatorio por cada archivo cifrado.

El IV se adjunta al inicio del archivo .enc, permitiendo el descifrado sin almacenamiento externo de IV.

---

## üì¶ Archivos encriptados

Solo los siguientes archivos deben ser versionados (subidos a Git):

- `env.qa.json.enc`
- `env.devel.json.enc`
- `env.pre-prod.json.enc`

Los `.json` planos deben agregarse al `.gitignore`.

---

## ‚öôÔ∏è Requisitos

- Node.js `>= 16`
- Tener definidos los scripts:
  - `scripts/encrypt-env.js`
  - `scripts/decrypt-env.js`
- Clave segura definida como variable de entorno `ENV_SECRET_KEY`.

---

## üõ†Ô∏è Comandos para cifrado y descifrado

| Acci√≥n            | Entorno       | Comando                                                                 |
|-------------------|---------------|-------------------------------------------------------------------------|
| **Cifrar archivos**     | PowerShell    | `$env:ENV_SECRET_KEY = "clave-secreta"; node scripts/encrypt-env.js`  |
|                       | Bash / Linux | `ENV_SECRET_KEY="clave-secreta" node scripts/encrypt-env.js`          |
| **Descifrar archivos** | PowerShell    | `$env:ENV_SECRET_KEY = "clave-secreta"; node scripts/decrypt-env.js`  |
|                       | Bash / Linux | `ENV_SECRET_KEY="clave-secreta" node scripts/decrypt-env.js`          |

> üìù Reemplaza `"clave-secreta"` por tu clave real del entorno (`qa`, `devel`, `pre-prod`).

> üìù !Importante, se debe ejecutar una parte del comando primero y luego la siguiente:

    > 1.- `$env:ENV_SECRET_KEY = "clave-secreta"; `
    > 2.-  `node scripts/encrypt-env.js `


üìå La clave **nunca debe subirse al repositorio**. Debe definirse como variable local o en Azure DevOps como `ENV_SECRET_KEY` protegida.


---

### ‚úÖ Comandos de Ejecuci√≥n

Antes de ejecutar debemos considerar tener la versi√≥n de java instalada 
si no existe su variable de entorno seteada podemos a trav√©s de powerShell usar:

```bash
$env:JAVA_HOME="C:\Program Files\Java\jdk-17"
```

## Importante

> Por defecto karate-config.js esta preparado para trabajar con 
un environment en este caso .qa por lo que cualqueir comando que
no incluya esta informaci√≥n se va a ejecutar contra QA, pero 
si queremos setear otro ambiente debemos usar el parametro
"-Dkarate.env=qa", "-Dkarate.env=devel", "-Dkarate.env=pre-prod"
archivos que podemos encontrar en 

```bash
src\test\resources\env.qa.json
```

## Crear schemas para validar en los escenarios

```bash
# 1.- Debemos copiar nuestro response a convertir en
scripts\input\input-response.json

# 2.- Ejecutar segun terminal

# powershell
scripts/generate-schema.bat   

# bash
bash scripts/generate-schema.sh

# 3.- Validar la salida del schema en:
scripts\out-put\schema.json

# 4.- llevar el archivo de salida a la api que se desea trabajar
# Renombrar el archivo segun sea el caso
ej: 

"src\test\content-manager-api\document\post\schemas\sucessful-response.json"
```


## Ejecuciones Manuales desde CLI powerShell

```bash
# Todos los tests - "-Dsurefire.printSummary=false" imprime en consola un log mas limpio
mvn test "-Dtest=test.RunAllTests" "-Dkarate.env=qa" "-Dsurefire.printSummary=false" 

# Solo ContentApi
mvn test "-Dtest=test.RunContentApi" "-Dkarate.env=devel" "-Dsurefire.printSummary=false" 

# Ejecutar ContentApi mediante un TAG
mvn test "-Dtest=test.RunContentApi" "-Dkarate.env=devel" "-Dkarate.options=--tags @CONTENT-MANAGER" "-Dsurefire.printSummary=false"

# Solo Template Api
mvn test "-Dtest=test.RunTemplateApi" "-Dkarate.env=qa" "-Dsurefire.printSummary=false" 


```

> Aseg√∫rate que las clases `RunLoginTests.java` y `RunUserTests.java` est√©n ubicadas correctamente bajo `src/test/java/login/post/` y `src/test/java/user/post/` respectivamente.


## Ejecuciones Manuales desde CLI gitBash con script
> En terminal bash ejecutar "bash script/run-login-tests.sh", archivo que contiene los comandos para correr todos los test


---

## ‚öôÔ∏è Configuraci√≥n por Entorno (`karate-config.js`)

```javascript
function fn() {
  var env = karate.env || 'qa';
  var config = {
    baseUrl: 'https://api-qa.example.com'
  };

  if (env === 'dev') {
    config.baseUrl = 'https://api-dev.example.com';
  } else if (env === 'prod') {
    config.baseUrl = 'https://api.example.com';
  }

  return config;
}
```

---

## üìÑ Reportes de Ejecuci√≥n

Karate genera reportes HTML autom√°ticos por cada `.feature` en:

```
target/karate-reports/
```

Tambi√©n puedes integrarlo con **Allure**, **ExtentReports**, o exportar datos personalizados si lo necesitas.

---

## üì¶ Dependencias en `pom.xml`

```xml
<dependencies>
  <dependency>
    <groupId>com.intuit.karate</groupId>
    <artifactId>karate-junit5</artifactId>
    <version>1.4.1</version>
    <scope>test</scope>
  </dependency>
  <dependency>
    <groupId>com.microsoft.sqlserver</groupId>
    <artifactId>mssql-jdbc</artifactId>
    <version>12.6.1.jre11</version>
  </dependency>
</dependencies>
```

---

## üöÄ Integraci√≥n Continua

Este proyecto es apto para CI/CD con:

- GitHub Actions
- GitLab CI
- Jenkins
- Azure Devops

Simplemente ejecuta los comandos Maven dentro del job correspondiente.

---

## üë®‚Äçüíª Autor

Proyecto desarrollado y mantenido por **GCM**.